{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Gesti√≥n de Proveedores - Dulcer√≠a Lilis{% endblock %}

{% block extra_css %}
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<!-- Animate.css -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

<style>
    .provider-card {
        border: 1px solid var(--lilis-gray-300);
        border-radius: 12px;
        transition: all 0.3s ease;
    }
    
    .provider-card:hover {
        border-color: var(--lilis-blue);
        box-shadow: 0 4px 12px rgba(79, 129, 247, 0.15);
    }
    
    .provider-logo {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        background: var(--lilis-gray-200);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: var(--lilis-blue);
    }
    
    .provider-rating {
        color: var(--lilis-yellow);
    }
    
    .contact-info {
        font-size: 0.85rem;
        color: var(--lilis-gray-600);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center gap-3">
            <a href="{% url 'dashboard:home' %}" class="btn btn-outline-secondary" title="Volver al inicio">
                <i class="bi bi-arrow-left"></i>
            </a>
            <div>
                <h2 class="text-dark fw-bold mb-1">
                    <i class="bi bi-building text-lilis-blue me-2"></i>
                    Gesti√≥n de Proveedores
                </h2>
                <p class="text-muted mb-0">Administra la red de proveedores de la dulcer√≠a</p>
            </div>
        </div>
        <button class="btn btn-lilis-primary" data-bs-toggle="modal" data-bs-target="#providerModal">
            <i class="bi bi-plus-circle me-2"></i>
            Nuevo Proveedor
        </button>
    </div>
    
    <!-- Stats Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="lilis-card">
                <div class="lilis-card-body text-center">
                    <div class="fs-2 fw-bold text-lilis-blue mb-1">{{ proveedores_count|default:0 }}</div>
                    <div class="text-muted">
                        <i class="bi bi-building me-1"></i>
                        Total Proveedores
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="lilis-card">
                <div class="lilis-card-body text-center">
                    <div class="fs-2 fw-bold text-lilis-green mb-1">{{ proveedores_activos|default:0 }}</div>
                    <div class="text-muted">
                        <i class="bi bi-check-circle me-1"></i>
                        Activos
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="lilis-card">
                <div class="lilis-card-body text-center">
                    <div class="fs-2 fw-bold text-lilis-yellow mb-1">{{ productos_proveedor|default:0 }}</div>
                    <div class="text-muted">
                        <i class="bi bi-box-seam me-1"></i>
                        Productos Asociados
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="lilis-card">
                <div class="lilis-card-body text-center">
                    <div class="fs-2 fw-bold text-lilis-red mb-1">{{ ordenes_pendientes|default:0 }}</div>
                    <div class="text-muted">
                        <i class="bi bi-clock me-1"></i>
                        √ìrdenes Pendientes
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Alert Container -->
    <div class="alert-container mb-3">
        {% if messages %}
            {% for message in messages %}
                <div class="lilis-alert lilis-alert-{{ message.tags|default:'info' }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    </div>
    
    <!-- Filters Card -->
    <div class="lilis-card mb-4">
        <div class="lilis-card-body">
            <h5 class="mb-3">
                <i class="bi bi-search me-2"></i>
                Buscar proveedores
            </h5>
            
            <form method="get" id="searchForm">
                <div class="row g-3 align-items-end">
                    <!-- Buscador -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold mb-2">
                            <i class="bi bi-filter me-1"></i>
                            Buscar por nombre, contacto o direcci√≥n
                        </label>
                        <div class="input-group">
                            <span class="input-group-text bg-white">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" 
                                   class="form-control" 
                                   name="search" 
                                   id="searchProvider" 
                                   placeholder="Escribe para buscar..."
                                   value="{{ search }}">
                            {% if search %}
                            <a href="{% url 'dashboard:proveedores' %}" 
                               class="btn btn-outline-secondary"
                               title="Limpiar b√∫squeda">
                                <i class="bi bi-x-lg"></i>
                            </a>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Registros por p√°gina -->
                    <div class="col-md-2">
                        <label class="form-label fw-bold mb-2">
                            <i class="bi bi-list-ol me-1"></i>
                            Registros por p√°gina
                        </label>
                        <select class="form-select" id="perPageSelect" onchange="changePerPage(this.value)">
                            <option value="5" {% if per_page == 5 %}selected{% endif %}>5 registros</option>
                            <option value="10" {% if per_page == 10 %}selected{% endif %}>10 registros</option>
                            <option value="15" {% if per_page == 15 %}selected{% endif %}>15 registros</option>
                            <option value="30" {% if per_page == 30 %}selected{% endif %}>30 registros</option>
                            <option value="50" {% if per_page == 50 %}selected{% endif %}>50 registros</option>
                        </select>
                    </div>
                    
                    <!-- Ordenar por -->
                    <div class="col-md-2">
                        <label class="form-label fw-bold mb-2">
                            <i class="bi bi-sort-alpha-down me-1"></i>
                            Ordenar por
                        </label>
                        <select class="form-select" id="orderBySelect" onchange="changeOrderBy(this.value)">
                            <option value="id_proveedor" {% if order_by == 'id_proveedor' %}selected{% endif %}>ID</option>
                            <option value="nombre" {% if order_by == 'nombre' %}selected{% endif %}>Nombre</option>
                            <option value="contacto" {% if order_by == 'contacto' %}selected{% endif %}>Contacto</option>
                        </select>
                    </div>
                    
                    <!-- Direcci√≥n de orden -->
                    <div class="col-md-2">
                        <label class="form-label fw-bold mb-2">
                            <i class="bi bi-arrow-down-up me-1"></i>
                            Direcci√≥n
                        </label>
                        <button type="button" 
                                class="btn w-100" 
                                style="background: linear-gradient(135deg, var(--lilis-blue), var(--lilis-blue-hover)); color: white; font-weight: 600;"
                                onclick="toggleOrderDirection()" 
                                id="orderDirectionBtn">
                            <i class="bi bi-sort-{% if order_direction == 'desc' %}down{% else %}up{% endif %} me-2"></i>
                            {% if order_direction == 'desc' %}Descendente{% else %}Ascendente{% endif %}
                        </button>
                    </div>
                </div>
            </form>
            
            <!-- Informaci√≥n y bot√≥n exportar -->
            <div class="row mt-4 pt-3 border-top">
                <div class="col-md-6 d-flex align-items-center">
                    <a href="{% url 'dashboard:exportar_proveedores_excel' %}" class="btn btn-outline-success">
                        <i class="bi bi-file-earmark-excel me-2"></i>
                        Exportar a Excel
                    </a>
                </div>
                <div class="col-md-6 text-end">
                    <span class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        Mostrando 
                        <strong>{{ proveedores.start_index }}</strong> - <strong>{{ proveedores.end_index }}</strong> 
                        de <strong>{{ proveedores.paginator.count }}</strong> proveedores
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Providers Table -->
    <div class="lilis-card">
        <div class="lilis-card-header d-flex justify-content-between align-items-center">
            <h5 class="lilis-card-title mb-0">
                <i class="bi bi-table me-2"></i>
                Lista de Proveedores
            </h5>
            <span class="badge bg-secondary">{{ proveedores.paginator.count }} proveedores totales</span>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="providersTable">
                <thead class="table-light">
                    <tr>
                        <th scope="col" style="cursor: pointer;" onclick="sortTable('id_proveedor')">
                            <i class="bi bi-hash me-1"></i>ID
                            {% if order_by == 'id_proveedor' %}
                                <i class="bi bi-caret-{% if order_direction == 'desc' %}down{% else %}up{% endif %}-fill"></i>
                            {% endif %}
                        </th>
                        <th scope="col" style="cursor: pointer;" onclick="sortTable('nombre')">
                            <i class="bi bi-building me-1"></i>Nombre
                            {% if order_by == 'nombre' %}
                                <i class="bi bi-caret-{% if order_direction == 'desc' %}down{% else %}up{% endif %}-fill"></i>
                            {% endif %}
                        </th>
                        <th scope="col" style="cursor: pointer;" onclick="sortTable('contacto')">
                            <i class="bi bi-person me-1"></i>Contacto
                            {% if order_by == 'contacto' %}
                                <i class="bi bi-caret-{% if order_direction == 'desc' %}down{% else %}up{% endif %}-fill"></i>
                            {% endif %}
                        </th>
                        <th scope="col">
                            <i class="bi bi-geo-alt me-1"></i>Direcci√≥n
                        </th>
                        <th scope="col" class="text-center">
                            <i class="bi bi-gear me-1"></i>Acciones
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for proveedor in proveedores %}
                    <tr data-provider-id="{{ proveedor.id_proveedor }}">
                        <td>
                            <span class="badge" style="background: linear-gradient(135deg, var(--lilis-blue), var(--lilis-blue-hover)); font-size: 0.9rem;">
                                #{{ proveedor.id_proveedor }}
                            </span>
                        </td>
                        <td>
                            <strong>{{ proveedor.nombre }}</strong>
                        </td>
                        <td>{{ proveedor.contacto|default:"Sin contacto" }}</td>
                        <td>
                            <span class="text-muted">{{ proveedor.direccion|default:"Sin direcci√≥n"|truncatechars:50 }}</span>
                        </td>
                        <td>
                            <div class="d-flex justify-content-center gap-1">
                                <button class="btn btn-sm btn-outline-info" 
                                        onclick="viewProvider('{{ proveedor.id_proveedor }}')" 
                                        title="Ver detalles">
                                    <i class="bi bi-eye"></i>
                                </button>
                                {% if user.is_superuser or user.id_rol.nombre == 'Administrador' %}
                                <button class="btn btn-sm" 
                                        style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white;"
                                        onclick="editProvider('{{ proveedor.id_proveedor }}')" 
                                        title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" 
                                        onclick="deleteProvider('{{ proveedor.id_proveedor }}', '{{ proveedor.nombre }}')" 
                                        title="Eliminar">
                                    <i class="bi bi-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center py-5">
                            <div class="text-muted">
                                <i class="bi bi-building display-4 d-block mb-3" style="color: var(--lilis-gray-300);"></i>
                                {% if search %}
                                    <p class="mb-3">No se encontraron proveedores que coincidan con "{{ search }}"</p>
                                    <a href="{% url 'dashboard:proveedores' %}" class="btn btn-lilis-primary">
                                        <i class="bi bi-arrow-left me-2"></i>
                                        Ver todos los proveedores
                                    </a>
                                {% else %}
                                    <p class="mb-3">No hay proveedores registrados</p>
                                    <button class="btn btn-lilis-primary" data-bs-toggle="modal" data-bs-target="#providerModal">
                                        <i class="bi bi-plus-circle me-2"></i>
                                        Crear primer proveedor
                                    </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Paginaci√≥n -->
        <div class="lilis-card-footer bg-light">
            <nav aria-label="Paginaci√≥n de proveedores">
                <ul class="pagination justify-content-center mb-0">
                    {% if proveedores.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{% if search %}&search={{ search }}{% endif %}&per_page={{ per_page }}&order_by={{ order_by }}&order_direction={{ order_direction }}" title="Primera p√°gina">
                                <i class="bi bi-chevron-double-left"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ proveedores.previous_page_number }}{% if search %}&search={{ search }}{% endif %}&per_page={{ per_page }}&order_by={{ order_by }}&order_direction={{ order_direction }}" title="P√°gina anterior">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link"><i class="bi bi-chevron-double-left"></i></span>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link"><i class="bi bi-chevron-left"></i></span>
                        </li>
                    {% endif %}
                    
                    {% for num in proveedores.paginator.page_range %}
                        {% if proveedores.number == num %}
                            <li class="page-item active">
                                <span class="page-link" style="background: linear-gradient(135deg, var(--lilis-blue), var(--lilis-blue-hover)); border-color: var(--lilis-blue);">{{ num }}</span>
                            </li>
                        {% elif num > proveedores.number|add:'-3' and num < proveedores.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ num }}{% if search %}&search={{ search }}{% endif %}&per_page={{ per_page }}&order_by={{ order_by }}&order_direction={{ order_direction }}">{{ num }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if proveedores.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ proveedores.next_page_number }}{% if search %}&search={{ search }}{% endif %}&per_page={{ per_page }}&order_by={{ order_by }}&order_direction={{ order_direction }}" title="P√°gina siguiente">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ proveedores.paginator.num_pages }}{% if search %}&search={{ search }}{% endif %}&per_page={{ per_page }}&order_by={{ order_by }}&order_direction={{ order_direction }}" title="√öltima p√°gina">
                                <i class="bi bi-chevron-double-right"></i>
                            </a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link"><i class="bi bi-chevron-right"></i></span>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link"><i class="bi bi-chevron-double-right"></i></span>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            
            <!-- Info de paginaci√≥n -->
            <div class="text-center mt-2">
                <small class="text-muted">
                    P√°gina {{ proveedores.number }} de {{ proveedores.paginator.num_pages }}
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Provider Modal -->
<div class="modal fade" id="providerModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title">
                    <i class="bi bi-building text-lilis-blue me-2"></i>
                    <span id="modalTitle">Nuevo Proveedor</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body">
                <!-- Step Indicator -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-center">
                            <div class="d-flex align-items-center">
                                <div class="step-item active" data-step="1">
                                    <div class="step-number">1</div>
                                    <div class="step-label">Identificaci√≥n y Contacto</div>
                                </div>
                                <div class="step-line"></div>
                                <div class="step-item" data-step="2">
                                    <div class="step-number">2</div>
                                    <div class="step-label">Direcci√≥n y Comercial</div>
                                </div>
                                <div class="step-line"></div>
                                <div class="step-item" data-step="3">
                                    <div class="step-number">3</div>
                                    <div class="step-label">Relaci√≥n con Productos</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <form id="providerForm">
                    {% csrf_token %}
                    <input type="hidden" id="proveedorId" name="proveedor_id">
                    
                    <!-- Step 1: Identificaci√≥n y Contacto -->
                    <div class="step-content" data-step="1">
                        <h6 class="text-lilis-blue mb-3">
                            <i class="bi bi-person-badge me-2"></i>
                            Informaci√≥n de Identificaci√≥n y Contacto
                        </h6>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="lilis-form-label">Nombre del Proveedor *</label>
                                <input type="text" class="lilis-form-control" id="proveedorNombre" name="nombre" required maxlength="150">
                                <div class="lilis-form-text">Nombre comercial o raz√≥n social</div>
                            </div>
                            <div class="col-md-6">
                                <label class="lilis-form-label">RUT *</label>
                                <input type="text" class="lilis-form-control" id="proveedorRut" name="rut" required maxlength="11">
                                <div class="lilis-form-text">Rol √önico Tributario</div>
                            </div>
                            <div class="col-md-6">
                                <label class="lilis-form-label">Persona de Contacto</label>
                                <input type="text" class="lilis-form-control" id="proveedorContacto" name="contacto" maxlength="200">
                            </div>
                            <div class="col-md-6">
                                <label class="lilis-form-label">Cargo del Contacto</label>
                                <input type="text" class="lilis-form-control" id="proveedorCargo" name="cargo_contacto" maxlength="100">
                            </div>
                            <div class="col-md-6">
                                <label class="lilis-form-label">Tel√©fono Principal *</label>
                                <input type="tel" class="lilis-form-control" id="proveedorTelefono" name="telefono" required maxlength="15">
                            </div>
                            <div class="col-md-6">
                                <label class="lilis-form-label">Tel√©fono Secundario</label>
                                <input type="tel" class="lilis-form-control" id="proveedorTelefono2" name="telefono_secundario" maxlength="15">
                            </div>
                            <div class="col-md-6">
                                <label class="lilis-form-label">Email Principal *</label>
                                <input type="email" class="lilis-form-control" id="proveedorEmail" name="email" required maxlength="150">
                            </div>
                            <div class="col-md-6">
                                <label class="lilis-form-label">Email Secundario</label>
                                <input type="email" class="lilis-form-control" id="proveedorEmail2" name="email_secundario" maxlength="150">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 2: Direcci√≥n y Comercial -->
                    <div class="step-content d-none" data-step="2">
                        <h6 class="text-lilis-blue mb-3">
                            <i class="bi bi-geo-alt me-2"></i>
                            Informaci√≥n de Direcci√≥n y Comercial
                        </h6>
                        
                        <div class="row g-3">
                            <div class="col-md-12">
                                <label class="lilis-form-label">Direcci√≥n *</label>
                                <input type="text" class="lilis-form-control" id="proveedorDireccion" name="direccion" required maxlength="200" placeholder="Calle y n√∫mero">
                            </div>
                            <div class="col-md-6">
                                <label class="lilis-form-label">Comuna *</label>
                                <input type="text" class="lilis-form-control" id="proveedorComuna" name="comuna" required maxlength="100" placeholder="Ej: Providencia, Las Condes">
                            </div>
                            <div class="col-md-6">
                                <label class="lilis-form-label">Regi√≥n *</label>
                                <select class="lilis-form-control" id="proveedorRegion" name="region" required>
                                    <option value="">Seleccionar regi√≥n...</option>
                                    <option value="Regi√≥n de Arica y Parinacota">Regi√≥n de Arica y Parinacota</option>
                                    <option value="Regi√≥n de Tarapac√°">Regi√≥n de Tarapac√°</option>
                                    <option value="Regi√≥n de Antofagasta">Regi√≥n de Antofagasta</option>
                                    <option value="Regi√≥n de Atacama">Regi√≥n de Atacama</option>
                                    <option value="Regi√≥n de Coquimbo">Regi√≥n de Coquimbo</option>
                                    <option value="Regi√≥n de Valpara√≠so">Regi√≥n de Valpara√≠so</option>
                                    <option value="Regi√≥n Metropolitana">Regi√≥n Metropolitana</option>
                                    <option value="Regi√≥n del Libertador Gral. Bernardo O'Higgins">Regi√≥n del Libertador Gral. Bernardo O'Higgins</option>
                                    <option value="Regi√≥n del Maule">Regi√≥n del Maule</option>
                                    <option value="Regi√≥n de √ëuble">Regi√≥n de √ëuble</option>
                                    <option value="Regi√≥n del Biob√≠o">Regi√≥n del Biob√≠o</option>
                                    <option value="Regi√≥n de La Araucan√≠a">Regi√≥n de La Araucan√≠a</option>
                                    <option value="Regi√≥n de Los R√≠os">Regi√≥n de Los R√≠os</option>
                                    <option value="Regi√≥n de Los Lagos">Regi√≥n de Los Lagos</option>
                                    <option value="Regi√≥n Ays√©n del Gral. Carlos Ib√°√±ez del Campo">Regi√≥n Ays√©n del Gral. Carlos Ib√°√±ez del Campo</option>
                                    <option value="Regi√≥n de Magallanes y de la Ant√°rtica Chilena">Regi√≥n de Magallanes y de la Ant√°rtica Chilena</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="lilis-form-label">Tipo de Proveedor</label>
                                <select class="lilis-form-control" id="proveedorTipo" name="tipo_proveedor">
                                    <option value="">Seleccionar...</option>
                                    <option value="distribuidor">Distribuidor</option>
                                    <option value="fabricante">Fabricante</option>
                                    <option value="mayorista">Mayorista</option>
                                    <option value="importador">Importador</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="lilis-form-label">Condiciones de Pago</label>
                                <select class="lilis-form-control" id="proveedorCondicionesPago" name="condiciones_pago">
                                    <option value="">Seleccionar...</option>
                                    <option value="contado">Contado</option>
                                    <option value="credito_15">Cr√©dito 15 d√≠as</option>
                                    <option value="credito_30">Cr√©dito 30 d√≠as</option>
                                    <option value="credito_45">Cr√©dito 45 d√≠as</option>
                                    <option value="credito_60">Cr√©dito 60 d√≠as</option>
                                    <option value="credito_90">Cr√©dito 90 d√≠as</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="lilis-form-label">Tiempo de Entrega (d√≠as)</label>
                                <input type="number" class="lilis-form-control" id="proveedorTiempoEntrega" name="tiempo_entrega" min="1" max="365" placeholder="D√≠as h√°biles">
                            </div>
                            <div class="col-md-6">
                                <label class="lilis-form-label">Monto M√≠nimo de Pedido (CLP)</label>
                                <input type="number" step="1" class="lilis-form-control" id="proveedorMontoMinimo" name="monto_minimo" min="0" placeholder="Pesos chilenos">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 3: Relaci√≥n con Productos -->
                    <div class="step-content d-none" data-step="3">
                        <h6 class="text-lilis-blue mb-3">
                            <i class="bi bi-box-seam me-2"></i>
                            Relaci√≥n con Productos
                        </h6>
                        
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="lilis-form-label">Productos que Suministra</label>
                                <div class="lilis-form-text mb-2">Selecciona los productos que este proveedor puede suministrar</div>
                                <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                    <div class="row">
                                        {% for producto in productos_disponibles %}
                                        <div class="col-md-6 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="productos[]" value="{{ producto.id_producto }}" id="product_{{ producto.id_producto }}">
                                                <label class="form-check-label" for="product_{{ producto.id_producto }}">
                                                    {{ producto.nombre }}
                                                </label>
                                            </div>
                                        </div>
                                        {% empty %}
                                        <div class="col-12 text-center text-muted py-3">
                                            <i class="bi bi-info-circle me-2"></i>
                                            No hay productos disponibles. Crea productos primero.
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="lilis-form-label">Observaciones</label>
                                <textarea class="lilis-form-control" name="observaciones" rows="4" placeholder="Informaci√≥n adicional sobre el proveedor..."></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="modal-footer bg-light">
                <div class="d-flex justify-content-between w-100">
                    <button type="button" class="btn btn-outline-secondary" id="prevStepBtn" onclick="previousStep()" style="display: none;">
                        <i class="bi bi-arrow-left me-1"></i>
                        Anterior
                    </button>
                    <div class="ms-auto d-flex gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-lilis-primary" id="nextStepBtn" onclick="nextStep()">
                            Siguiente
                            <i class="bi bi-arrow-right ms-1"></i>
                        </button>
                        <button type="button" class="btn btn-success" id="submitBtn" onclick="submitProvider()" style="display: none;">
                            <i class="bi bi-check-lg me-1"></i>
                            Guardar Proveedor
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    let currentStep = 1;
    const totalSteps = 3;
    
    // Funci√≥n para obtener el CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Provider Management Functions
    function viewProvider(providerId) {
        // Mostrar loading
        Swal.fire({
            title: 'Cargando detalles...',
            allowOutsideClick: false,
            showConfirmButton: false,
            willOpen: () => {
                Swal.showLoading();
            }
        });
        
        // Obtener datos del proveedor
        fetch(`/dashboard/proveedores/obtener/${providerId}/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            Swal.close();
            
            if (data.success) {
                const proveedor = data.proveedor;
                
                // Crear lista de productos
                let productosHtml = '';
                if (proveedor.productos_detalle && proveedor.productos_detalle.length > 0) {
                    productosHtml = `
                        <div class="mt-4 pt-3 border-top">
                            <h6 class="text-primary mb-3">
                                üì¶ Productos que Suministra
                                <span class="badge bg-primary ms-2">${proveedor.productos_detalle.length}</span>
                            </h6>
                            <div class="d-flex flex-wrap gap-2">
                    `;
                    proveedor.productos_detalle.forEach(producto => {
                        productosHtml += `
                            <span class="badge bg-primary" style="font-size: 0.85rem; padding: 0.5rem 0.75rem;">
                                ‚úì ${producto.nombre}
                            </span>
                        `;
                    });
                    productosHtml += `
                            </div>
                        </div>
                    `;
                } else {
                    productosHtml = `
                        <div class="mt-4 pt-3 border-top">
                            <div class="alert alert-info mb-0">
                                ‚ÑπÔ∏è Sin productos asociados actualmente
                            </div>
                        </div>
                    `;
                }
                
                // Mostrar detalles en SweetAlert
                Swal.fire({
                    title: 'üè¢ ' + proveedor.nombre,
                    html: `
                        <div class="text-start mt-4">
                            <div class="mb-3 text-muted small">
                                ID del Proveedor: <strong>#${proveedor.id}</strong>
                            </div>
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="card border-0 shadow-sm h-100 bg-light">
                                        <div class="card-body">
                                            <h6 class="text-primary mb-2">üë§ Contacto</h6>
                                            <p class="mb-0 fw-semibold">${proveedor.contacto || '<span class="text-muted">Sin contacto</span>'}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="card border-0 shadow-sm h-100 bg-light">
                                        <div class="card-body">
                                            <h6 class="text-success mb-2">üìç Direcci√≥n</h6>
                                            <p class="mb-0 fw-semibold">${proveedor.direccion || '<span class="text-muted">Sin direcci√≥n</span>'}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="card border-0 shadow-sm h-100 bg-light">
                                        <div class="card-body">
                                            <h6 class="text-info mb-2">üèòÔ∏è Comuna</h6>
                                            <p class="mb-0 fw-semibold">${proveedor.comuna || '<span class="text-muted">No especificada</span>'}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="card border-0 shadow-sm h-100 bg-light">
                                        <div class="card-body">
                                            <h6 class="text-warning mb-2">üö© Regi√≥n</h6>
                                            <p class="mb-0 fw-semibold">${proveedor.region || '<span class="text-muted">No especificada</span>'}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            ${productosHtml}
                        </div>
                    `,
                    confirmButtonText: '‚úï Cerrar',
                    confirmButtonColor: '#4f81f7',
                    width: '800px',
                    customClass: {
                        popup: 'rounded-4 shadow-lg'
                    }
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message || 'No se pudieron cargar los detalles',
                    confirmButtonColor: 'var(--lilis-blue)'
                });
            }
        })
        .catch(error => {
            Swal.close();
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Error al cargar los detalles del proveedor',
                confirmButtonColor: 'var(--lilis-blue)'
            });
        });
    }
    
    function editProvider(providerId) {
        // Mostrar loading
        Swal.fire({
            title: 'Cargando datos...',
            allowOutsideClick: false,
            showConfirmButton: false,
            willOpen: () => {
                Swal.showLoading();
            }
        });
        
        // Obtener datos del proveedor
        fetch(`/dashboard/proveedores/obtener/${providerId}/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            Swal.close();
            
            if (data.success) {
                const proveedor = data.proveedor;
                
                // Llenar el formulario con los datos
                document.getElementById('proveedorId').value = proveedor.id;
                document.getElementById('proveedorNombre').value = proveedor.nombre;
                document.getElementById('proveedorContacto').value = proveedor.contacto || '';
                document.getElementById('proveedorDireccion').value = proveedor.direccion || '';
                document.getElementById('proveedorComuna').value = proveedor.comuna || '';
                document.getElementById('proveedorRegion').value = proveedor.region || '';
                
                // Desmarcar todos los checkboxes primero
                document.querySelectorAll('input[name="productos[]"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                // Marcar los productos asociados
                if (proveedor.productos && proveedor.productos.length > 0) {
                    proveedor.productos.forEach(productoId => {
                        const checkbox = document.querySelector(`input[name="productos[]"][value="${productoId}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                }
                
                // Cambiar t√≠tulo del modal
                document.getElementById('modalTitle').textContent = 'Editar Proveedor';
                
                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('providerModal'));
                modal.show();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message || 'No se pudieron cargar los datos',
                    confirmButtonColor: 'var(--lilis-blue)'
                });
            }
        })
        .catch(error => {
            Swal.close();
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Error al cargar los datos del proveedor',
                confirmButtonColor: 'var(--lilis-blue)'
            });
        });
    }
    
    function submitProvider() {
        const form = document.getElementById('providerForm');
        const formData = new FormData(form);
        
        // Validar solo campos m√≠nimos requeridos del modelo actual
        const nombre = formData.get('nombre');
        const contacto = formData.get('contacto');
        const direccion = formData.get('direccion');
        
        if (!nombre || !nombre.trim()) {
            Swal.fire({
                icon: 'warning',
                title: 'Campo requerido',
                text: 'El nombre del proveedor es requerido',
                confirmButtonColor: 'var(--lilis-blue)'
            });
            document.getElementById('proveedorNombre').focus();
            currentStep = 1;
            updateStepDisplay();
            return;
        }
        
        if (!contacto || !contacto.trim()) {
            Swal.fire({
                icon: 'warning',
                title: 'Campo requerido',
                text: 'El contacto es requerido',
                confirmButtonColor: 'var(--lilis-blue)'
            });
            document.getElementById('proveedorContacto').focus();
            currentStep = 1;
            updateStepDisplay();
            return;
        }
        
        if (!direccion || !direccion.trim()) {
            Swal.fire({
                icon: 'warning',
                title: 'Campo requerido',
                text: 'La direcci√≥n es requerida',
                confirmButtonColor: 'var(--lilis-blue)'
            });
            document.getElementById('proveedorDireccion').focus();
            currentStep = 2;
            updateStepDisplay();
            return;
        }
        
        // Mostrar loading
        Swal.fire({
            title: 'Guardando...',
            allowOutsideClick: false,
            showConfirmButton: false,
            willOpen: () => {
                Swal.showLoading();
            }
        });
        
        // Enviar datos
        fetch('/dashboard/proveedores/guardar/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            Swal.close();
            
            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: '¬°√âxito!',
                    text: data.message,
                    confirmButtonColor: 'var(--lilis-blue)'
                }).then(() => {
                    location.reload();
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message || 'Error al guardar el proveedor',
                    confirmButtonColor: 'var(--lilis-blue)'
                });
            }
        })
        .catch(error => {
            Swal.close();
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Ocurri√≥ un error al procesar la solicitud',
                confirmButtonColor: 'var(--lilis-blue)'
            });
        });
    }
    
    // Step Navigation Functions
    function nextStep() {
        if (validateCurrentStep()) {
            if (currentStep < totalSteps) {
                currentStep++;
                updateStepDisplay();
            }
        }
    }
    
    function previousStep() {
        if (currentStep > 1) {
            currentStep--;
            updateStepDisplay();
        }
    }
    
    function updateStepDisplay() {
        // Update step indicators
        document.querySelectorAll('.step-item').forEach((item, index) => {
            const stepNumber = index + 1;
            item.classList.remove('active', 'completed');
            
            if (stepNumber < currentStep) {
                item.classList.add('completed');
            } else if (stepNumber === currentStep) {
                item.classList.add('active');
            }
        });
        
        // Update step content
        document.querySelectorAll('.step-content').forEach((content, index) => {
            const stepNumber = index + 1;
            if (stepNumber === currentStep) {
                content.classList.remove('d-none');
            } else {
                content.classList.add('d-none');
            }
        });
        
        // Update buttons
        const prevBtn = document.getElementById('prevStepBtn');
        const nextBtn = document.getElementById('nextStepBtn');
        const submitBtn = document.getElementById('submitBtn');
        
        if (prevBtn && nextBtn && submitBtn) {
            prevBtn.style.display = currentStep === 1 ? 'none' : 'block';
            
            if (currentStep === totalSteps) {
                nextBtn.style.display = 'none';
                submitBtn.style.display = 'block';
            } else {
                nextBtn.style.display = 'block';
                submitBtn.style.display = 'none';
            }
        }
    }
    
    function validateCurrentStep() {
        const currentStepContent = document.querySelector(`.step-content[data-step="${currentStep}"]`);
        if (!currentStepContent) return true;
        
        const requiredFields = currentStepContent.querySelectorAll('[required]');
        let isValid = true;
        
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            } else {
                field.classList.remove('is-invalid');
            }
        });
        
        if (!isValid) {
            Swal.fire({
                icon: 'warning',
                title: 'Campos incompletos',
                text: 'Por favor completa todos los campos requeridos',
                confirmButtonColor: 'var(--lilis-blue)'
            });
        }
        
        return isValid;
    }
    
    function resetProviderForm() {
        currentStep = 1;
        document.getElementById('providerForm').reset();
        document.getElementById('proveedorId').value = '';
        document.getElementById('modalTitle').textContent = 'Nuevo Proveedor';
        document.querySelectorAll('.is-invalid').forEach(field => {
            field.classList.remove('is-invalid');
        });
        // Desmarcar todos los productos
        document.querySelectorAll('input[name="productos[]"]').forEach(checkbox => {
            checkbox.checked = false;
        });
        updateStepDisplay();
    }
    
    // Pagination and Sort Functions
    function changePerPage(value) {
        const url = new URL(window.location.href);
        url.searchParams.set('per_page', value);
        url.searchParams.set('page', '1'); // Reset to first page
        window.location.href = url.toString();
    }
    
    function changeOrderBy(value) {
        const url = new URL(window.location.href);
        url.searchParams.set('order_by', value);
        url.searchParams.set('page', '1'); // Reset to first page
        window.location.href = url.toString();
    }
    
    function toggleOrderDirection() {
        const url = new URL(window.location.href);
        const currentDirection = url.searchParams.get('order_direction') || 'asc';
        const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
        url.searchParams.set('order_direction', newDirection);
        url.searchParams.set('page', '1'); // Reset to first page
        window.location.href = url.toString();
    }
    
    function sortTable(column) {
        const url = new URL(window.location.href);
        const currentOrderBy = url.searchParams.get('order_by') || 'id_proveedor';
        const currentDirection = url.searchParams.get('order_direction') || 'asc';
        
        // Si se hace clic en la misma columna, cambiar direcci√≥n
        if (currentOrderBy === column) {
            const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
            url.searchParams.set('order_direction', newDirection);
        } else {
            // Si es una columna diferente, ordenar ascendente
            url.searchParams.set('order_by', column);
            url.searchParams.set('order_direction', 'asc');
        }
        
        url.searchParams.set('page', '1'); // Reset to first page
        window.location.href = url.toString();
    }
    
    function deleteProvider(providerId, providerName) {
        Swal.fire({
            title: '¬øEst√°s seguro?',
            html: `¬øDeseas eliminar el proveedor <strong>${providerName}</strong>?<br><small class="text-muted">Esta acci√≥n no se puede deshacer</small>`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: '<i class="bi bi-trash me-2"></i>S√≠, eliminar',
            cancelButtonText: '<i class="bi bi-x-circle me-2"></i>Cancelar',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                // Mostrar loading
                Swal.fire({
                    title: 'Eliminando...',
                    text: 'Por favor espera',
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    willOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                // Realizar petici√≥n
                fetch(`/dashboard/proveedores/eliminar/${providerId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: '¬°Eliminado!',
                            text: data.message || 'El proveedor ha sido eliminado correctamente',
                            confirmButtonColor: 'var(--lilis-blue)',
                            timer: 2000,
                            timerProgressBar: true
                        }).then(() => {
                            window.location.reload();
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: data.message || 'No se pudo eliminar el proveedor',
                            confirmButtonColor: 'var(--lilis-blue)'
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Error al eliminar el proveedor',
                        confirmButtonColor: 'var(--lilis-blue)'
                    });
                });
            }
        });
    }
    
    // Search form submit
    document.addEventListener('DOMContentLoaded', function() {
        const searchForm = document.getElementById('searchForm');
        const searchInput = document.getElementById('searchProvider');
        
        if (searchInput) {
            let searchTimeout;
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    searchForm.submit();
                }, 500); // Wait 500ms after user stops typing
            });
        }
    });
    
    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize step display
        updateStepDisplay();
        
        // Modal event listeners
        const modal = document.getElementById('providerModal');
        if (modal) {
            modal.addEventListener('hidden.bs.modal', resetProviderForm);
        }
        
        console.log('Provider management loaded with pagination, search and edit functionality');
    });
</script>

<style>
    .step-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        min-width: 120px;
    }
    
    .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--lilis-gray-300);
        color: var(--lilis-gray-600);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-bottom: 8px;
        transition: all 0.3s ease;
    }
    
    .step-item.active .step-number {
        background: var(--lilis-blue);
        color: white;
    }
    
    .step-item.completed .step-number {
        background: var(--lilis-green);
        color: white;
    }
    
    .step-label {
        font-size: 0.85rem;
        color: var(--lilis-gray-600);
        font-weight: 500;
    }
    
    .step-item.active .step-label {
        color: var(--lilis-blue);
        font-weight: 600;
    }
    
    .step-item.completed .step-label {
        color: var(--lilis-green);
        font-weight: 600;
    }
    
    .step-line {
        width: 100px;
        height: 2px;
        background: var(--lilis-gray-300);
        margin: 0 10px;
        margin-top: 20px;
    }
</style>
{% endblock %}